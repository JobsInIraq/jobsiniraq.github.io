---
layout: default
title: Data Validator
permalink: /validator/
---
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JobsInIraq — JSON Validator</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; line-height: 1.45; padding: 16px; }
    .wrap { max-width: 1100px; margin: 0 auto; }
    .card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; background:#fff; }
    h1 { margin: 0 0 12px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    input[type="file"] { padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px; background:#f9fafb; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #e5e7eb; background:#0f172a; color:#fff; cursor:pointer; }
    button.secondary { background:#fff; color:#0f172a; }
    .muted { color:#6b7280; }
    table { width:100%; border-collapse: collapse; margin-top: 14px; font-size: 14px; }
    th, td { border-bottom:1px solid #e5e7eb; text-align:left; padding:8px 6px; vertical-align: top; }
    tr:hover { background:#f9fafb; }
    .ok { color:#059669; font-weight:600; }
    .bad { color:#b91c1c; font-weight:600; }
    .pill { display:inline-block; padding:0 8px; border-radius:999px; border:1px solid #e5e7eb; font-size: 12px; background:#f3f4f6; }
    .grid { overflow:auto; max-height: 60vh; border:1px solid #e5e7eb; border-radius:10px; }
    .counts { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .small { font-size: 12px; }
    code { background:#f3f4f6; padding:2px 4px; border-radius:6px; }
  </style>
  <!-- Ajv + formats (UMD builds) -->
  <script src="https://cdn.jsdelivr.net/npm/ajv@8/dist/ajv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ajv-formats@2/dist/ajv-formats.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>JobsInIraq — JSON Validator</h1>
    <p class="muted">Validate <code>salaries.json</code> against <code>salaries.schema.json</code>, see <strong>all</strong> issues, and export a report with <strong>jobID</strong> &amp; titles for quick fixing. Runs fully in your browser.</p>
    <div class="row" style="margin:10px 0;">
      <div>
        <div class="small muted">Schema file</div>
        <input id="schemaFile" type="file" accept=".json,application/json">
      </div>
      <div>
        <div class="small muted">Data file</div>
        <input id="dataFile" type="file" accept=".json,application/json">
      </div>
      <div>
        <div>&nbsp;</div>
        <button id="runBtn">Validate (all errors)</button>
        <button id="exportCsvBtn" class="secondary" disabled>Export CSV</button>
      </div>
    </div>
    <div class="counts" id="summary"></div>
    <div id="status" class="muted" style="margin:8px 0 6px;"></div>
    <div class="grid">
      <table id="results">
        <thead>
          <tr>
            <th>#</th>
            <th>job index</th>
            <th>jobID</th>
            <th>title</th>
            <th>path</th>
            <th>keyword</th>
            <th>message</th>
            <th>sample</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// UMD glue
const AjvCtor = (window.ajv && window.ajv.default) || window.ajv || window.Ajv;
const addFormats = (window.ajvFormats && window.ajvFormats.default) || window.ajvFormats;

function jsonPointerGet(obj, pointer) {
  if (!pointer || pointer === "") return obj;
  const parts = pointer.split("/").slice(1).map(s => s.replace(/~1/g, "/").replace(/~0/g, "~"));
  let cur = obj;
  for (const p of parts) {
    if (Array.isArray(cur)) {
      const i = Number(p);
      cur = Number.isInteger(i) ? cur[i] : undefined;
    } else if (cur && Object.prototype.hasOwnProperty.call(cur, p)) {
      cur = cur[p];
    } else {
      return undefined;
    }
  }
  return cur;
}

function guessJobIndexFromPath(path) {
  const m = /^\/jobs\/(\d+)/.exec(path || "");
  return m ? Number(m[1]) : null;
}

function toCSV(rows) {
  const esc = (v) => {
    const s = String(v == null ? "" : v);
    return '"' + s.replace(/"/g, '""') + '"';
  };
  const header = ["#", "job_index", "jobID", "title", "path", "keyword", "message", "sample"];
  const out = [header.join(",")];
  rows.forEach(r => {
    out.push([r.idx, r.jobIndex, r.jobID, r.title, r.path, r.keyword, r.message, r.sample].map(esc).join(","));
  });
  return out.join("\n");
}

async function readJSON(fileInput) {
  const f = fileInput.files && fileInput.files[0];
  if (!f) throw new Error("No file selected for " + fileInput.id);
  const text = await f.text();
  return JSON.parse(text);
}

const runBtn = document.getElementById("runBtn");
const exportBtn = document.getElementById("exportCsvBtn");
const summaryEl = document.getElementById("summary");
const statusEl = document.getElementById("status");
const tbody = document.querySelector("#results tbody");

let lastRows = [];

runBtn.addEventListener("click", async () => {
  tbody.innerHTML = "";
  summaryEl.innerHTML = "";
  statusEl.textContent = "Running validation…";
  exportBtn.disabled = true;

  try {
    const schema = await readJSON(document.getElementById("schemaFile"));
    const data = await readJSON(document.getElementById("dataFile"));

    const ajv = new AjvCtor({ allErrors: true, strict: false, allowUnionTypes: true });
    if (addFormats) addFormats(ajv);

    const validate = ajv.compile(schema);
    const valid = validate(data);

    lastRows = [];
    if (valid) {
      statusEl.innerHTML = '<span class="ok">Valid ✅</span>';
    } else {
      statusEl.innerHTML = '<span class="bad">Invalid ❌ — listing all issues below</span>';
      const jobs = Array.isArray(data.jobs) ? data.jobs : [];
      validate.errors.forEach((e, i) => {
        const jobIndex = guessJobIndexFromPath(e.instancePath);
        let jobID = "", title = "", sample = "";
        if (jobIndex != null && jobs[jobIndex]) {
          jobID = jobs[jobIndex]?.jobID || "";
          title = jobs[jobIndex]?.job?.jobDetails?.jobTitle || "";
        }
        const val = jsonPointerGet(data, e.instancePath);
        if (val !== undefined && typeof val !== "object") sample = String(val);
        const row = {
          idx: i+1,
          jobIndex: jobIndex != null ? jobIndex : "",
          jobID, title,
          path: e.instancePath || "/",
          keyword: e.keyword || "",
          message: e.message || "",
          sample
        };
        lastRows.push(row);
      });

      // Render table
      const frag = document.createDocumentFragment();
      lastRows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.idx}</td>
                        <td>${r.jobIndex}</td>
                        <td><code>${r.jobID}</code></td>
                        <td>${r.title}</td>
                        <td><code>${r.path}</code></td>
                        <td><span class="pill">${r.keyword}</span></td>
                        <td>${r.message}</td>
                        <td>${r.sample ? `<code>${r.sample}</code>` : ""}</td>`;
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);

      // Summary pills
      const total = validate.errors.length;
      const byKeyword = validate.errors.reduce((acc, e) => (acc[e.keyword]=(acc[e.keyword]||0)+1, acc), {});
      const counts = [`<span class="pill">Total: ${total}</span>`]
        .concat(Object.entries(byKeyword).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<span class="pill">${k}: ${v}</span>`));
      summaryEl.innerHTML = counts.join(" ");
      exportBtn.disabled = false;
      exportBtn.onclick = () => {
        const csv = toCSV(lastRows);
        const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "validation-report.csv"; a.click();
        URL.revokeObjectURL(url);
      };
    }
  } catch (err) {
    console.error(err);
    statusEl.innerHTML = '<span class="bad">Failed to run: '+ (err && err.message ? err.message : err) +'</span>';
  }
});
</script>
</body>
</html>
